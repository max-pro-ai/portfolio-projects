# Исправление Email функциональности AI ChatBot + Telegram интеграция

## Проблема
Плагин не отправляет историю чата на почту по истечении таймера неактивности.

## Критическая ошибка (ИСПРАВЛЕНО)
**Fatal error: Cannot redeclare ai_chatbot_test_connection()** - возникала из-за дублирования функций в нескольких файлах.

### Что было исправлено:
- ✅ Убраны дублирующиеся функции `ai_chatbot_test_connection()` из `class-openai-api.php`
- ✅ Убраны дублирующиеся функции `ai_chatbot_clear_cache()` из `settings-page.php`
- ✅ Убраны дублирующиеся функции `ai_chatbot_test_email()` из `settings-page.php`
- ✅ Централизованы все AJAX обработчики в `ajax-handlers.php`
- ✅ Добавлено подключение `ajax-handlers.php` в основной файл плагина

## Что было исправлено

### 1. Основной файл плагина (`ai-chatbot.php`)
- ✅ Добавлено подключение класса `AI_ChatBot_Chat_Handler`
- ✅ Добавлено подключение `ajax-handlers.php`
- ✅ Убраны дублирующиеся AJAX обработчики
- ✅ Исправлена регистрация настроек плагина
- ✅ Добавлено создание таблицы для бесед при активации
- ✅ Добавлены настройки Telegram

### 2. JavaScript код (`assets/js/chatbot.js`)
- ✅ Исправлена функция `sendChatHistory()` для корректной отправки данных
- ✅ Добавлена функция `startInactivityTimer()` для правильного управления таймером
- ✅ Исправлена функция `getAllMessages()` для передачи timestamp
- ✅ Убраны дублирующиеся функции
- ✅ Добавлено подробное логирование для отладки
- ✅ Добавлены уведомления для пользователя
- ✅ **ИСПРАВЛЕНО: Таймер запускается при любом ответе бота (успех/ошибка)**
- ✅ **ИСПРАВЛЕНО: Таймер запускается при сетевых ошибках**
- ✅ **ИСПРАВЛЕНО: Таймер запускается при открытии чата с существующей историей**
- ✅ **ИСПРАВЛЕНО: Добавлена валидация таймаута и fallback значения**
- ✅ **ИСПРАВЛЕНО: Улучшена отладка таймера с временными метками**

### 3. Email Handler (`includes/email-handler.php`)
- ✅ Исправлена обработка данных от JavaScript
- ✅ Улучшено определение времени последнего сообщения
- ✅ Добавлена очистка HTML тегов из текста
- ✅ Добавлена функция очистки старых файлов истории
- ✅ Зарегистрирована cron задача для очистки
- ✅ **ИСПРАВЛЕНО: Используется `mail()` вместо `wp_mail()`**
- ✅ Добавлена интеграция с Telegram

### 4. Класс обработчика чата (`includes/class-chat-handler.php`)
- ✅ Добавлена проверка и создание таблицы для бесед
- ✅ Исправлен метод `get_conversation_history()` для правильного порядка сообщений
- ✅ Улучшен метод `save_conversation()` с логированием ошибок

### 5. AJAX обработчики (`includes/ajax-handlers.php`)
- ✅ Централизованы все AJAX функции
- ✅ Добавлена функция `ai_chatbot_test_email()`
- ✅ Добавлена функция `ai_chatbot_test_telegram()`
- ✅ **НОВОЕ: Добавлена функция `ai_chatbot_test_timer()` для тестирования таймера**
- ✅ **НОВОЕ: Добавлена функция `ai_chatbot_send_to_email()` для тестирования**
- ✅ Зарегистрированы все необходимые AJAX обработчики

### 6. Telegram интеграция (НОВОЕ!)
- ✅ Создан класс `AI_ChatBot_Telegram_Handler`
- ✅ Добавлены настройки Telegram в админ панель
- ✅ **ИСПРАВЛЕНО: Telegram настройки теперь корректно сохраняются**
- ✅ Автоматическая отправка истории чата в Telegram
- ✅ Тестирование Telegram подключения
- ✅ Поддержка длинных сообщений (разбиение на части)

### 7. CSS стили (`assets/css/chatbot.css`)
- ✅ Добавлены стили для уведомлений
- ✅ Анимации для уведомлений

### 8. Админ панель (`admin/settings-page.php`)
- ✅ **ИСПРАВЛЕНО: Добавлена обработка Telegram настроек в форме**
- ✅ **НОВОЕ: Добавлена кнопка "Тест таймера" для отладки**
- ✅ **НОВОЕ: Добавлено тестирование таймера с AJAX**

## Как работает исправленная система

1. **Пользователь отправляет сообщение** → Бот отвечает (успешно или с ошибкой)
2. **После ЛЮБОГО ответа бота запускается таймер** на время из настроек `ai_chatbot_inactivity_timeout`
3. **Таймер также запускается при сетевых ошибках** и при открытии чата с историей
4. **Если пользователь не пишет новое сообщение** → Таймер срабатывает
5. **История чата отправляется на email** через AJAX запрос
6. **Email handler сохраняет историю** и отправляет письмо через `mail()`
7. **Если включен Telegram** → История также отправляется в Telegram бот
8. **По истечении таймаута** отправляется письмо с полной историей переписки

### Ключевые улучшения таймера:
- ✅ **Таймер запускается после успешного ответа бота**
- ✅ **Таймер запускается после ошибки "Произошла ошибка. Попробуйте еще раз."**
- ✅ **Таймер запускается при сетевых ошибках**
- ✅ **Таймер запускается при открытии чата с существующей историей**
- ✅ **Таймер сбрасывается при отправке нового сообщения пользователем**

## Настройки для работы

### В админ панели WordPress:

#### Email настройки:
1. **Email для уведомлений** - укажите ваш email
2. **Таймаут неактивности** - время в миллисекундах (по умолчанию 300000 = 5 минут)

#### Telegram настройки:
1. **Включить Telegram уведомления** - галочка для активации
2. **Telegram Bot Token** - токен от @BotFather
3. **Telegram Chat ID** - ID чата для уведомлений

### Примеры таймаутов:
- 60000 мс = 1 минута
- 300000 мс = 5 минут (рекомендуется)
- 600000 мс = 10 минут

## Настройка Telegram

### 1. Создание бота:
1. Напишите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям и получите токен

### 2. Получение Chat ID:
- **Для личных сообщений**: ваш ID пользователя
- **Для групп**: ID группы (обычно начинается с -100)
- Используйте бота [@userinfobot](https://t.me/userinfobot) для получения ID

### 3. Настройка в админ панели:
1. Включите Telegram уведомления
2. Введите Bot Token
3. Введите Chat ID
4. Нажмите "Тест Telegram" для проверки

## Тестирование

### 1. Проверьте настройки:
- Email адрес настроен
- Таймаут установлен
- Плагин включен
- Telegram настроен (опционально)

### 2. Протестируйте чат:
- Отправьте несколько сообщений
- Дождитесь истечения таймаута
- Проверьте почту
- Проверьте Telegram (если настроен)

### 3. Отладка:
- Откройте консоль браузера (F12)
- Ищите сообщения с префиксом "AI ChatBot:"
- Проверьте логи WordPress

### 4. **НОВОЕ: Тестирование таймера:**
- В админ панели нажмите кнопку **"Тест таймера"**
- Проверьте консоль браузера на наличие сообщений о таймере
- Дождитесь истечения таймаута и проверьте почту
- Если таймер не работает, проверьте:
  - Значение `inactivity_timeout` в настройках
  - Логи в консоли браузера
  - Логи WordPress

### 5. **Проверка Telegram настроек:**
- Сохраните настройки Telegram в админ панели
- Нажмите "Тест Telegram" для проверки подключения
- Убедитесь что бот добавлен в чат и имеет права на отправку

## Логи и отладка

### Включите логирование WordPress:
```php
// Добавьте в wp-config.php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

### Проверьте логи:
- `/wp-content/debug.log` - общие ошибки WordPress
- `/wp-content/uploads/ai-chatbot-ajax-history/` - файлы истории чата

### Консоль браузера:
- Откройте F12 → Console
- Ищите сообщения "AI ChatBot:"

## Возможные проблемы

### 1. Email не отправляется:
- ✅ **ИСПРАВЛЕНО**: Теперь используется `mail()` вместо `wp_mail()`
- Проверьте настройки SMTP на сервере
- Убедитесь что функция `mail()` работает
- Проверьте спам фильтры

### 2. Таймер не срабатывает:
- Проверьте JavaScript консоль на ошибки
- Убедитесь что `inactivity_timeout` передается в JavaScript
- Проверьте что AJAX запросы работают

### 3. История не сохраняется:
- Проверьте права на запись в `/wp-content/uploads/`
- Убедитесь что таблица `ai_chatbot_conversations` создана
- Проверьте логи PHP

### 4. Telegram не работает:
- Проверьте правильность Bot Token
- Проверьте правильность Chat ID
- Убедитесь что бот добавлен в чат
- Проверьте права бота на отправку сообщений

## Структура файлов после исправления

```
ai-chatbot-plugin/
├── ai-chatbot.php (основной файл с исправлениями + Telegram)
├── includes/
│   ├── email-handler.php (исправленный + Telegram интеграция)
│   ├── class-chat-handler.php (исправленный класс чата)
│   ├── ajax-handlers.php (централизованные AJAX обработчики)
│   ├── class-telegram-handler.php (НОВЫЙ: Telegram интеграция)
│   └── class-openai-api.php (без дублирующихся функций)
├── assets/
│   ├── js/
│   │   └── chatbot.js (исправленный JavaScript + уведомления)
│   └── css/
│       └── chatbot.css (стили + уведомления)
└── README-EMAIL-FIX.md (этот файл)
```

## Проверка работоспособности

После внесения всех исправлений:

1. **Деактивируйте и активируйте плагин** заново
2. **Проверьте что таблица создана** в базе данных
3. **Настройте email и таймаут** в админ панели
4. **Настройте Telegram** (опционально)
5. **Протестируйте чат** с несколькими сообщениями
6. **Дождитесь истечения таймаута** и проверьте:
   - Почту
   - Telegram (если настроен)
7. **Проверьте консоль браузера** на наличие ошибок

## Поддержка

Если проблемы остаются:
1. Проверьте логи WordPress
2. Проверьте консоль браузера
3. Убедитесь что все файлы исправлены
4. Проверьте права доступа к файлам и папкам
5. Проверьте настройки SMTP и mail() на сервере
6. Проверьте настройки Telegram бота
